# Week 13: ノンパラメトリック検定

```{r, include=FALSE}
library(gt)
library(tidyverse)
library(kableExtra)
```

## ハンズオンと説明セッションを明確に分けずに行う

## 事前の確認

- この講義のRプロジェクトを開いていますか？
- 英数字で名前を付けた本日の講義のファイルを作成しましたか？

  - .Rでも.Rmdでもどちらでも大丈夫です。

## 今日の目標

1. 
2. 

## ノンパラメトリック検定
- 母集団に特定の分布を仮定しない検定に対して用いることができる手法。

  - e.g., カイ二乗検定、フィッシャーの正確確率検定

- 名義尺度データや順序尺度データの分析に使われる


## 名義尺度データ
- クロス集計表などで集計結果（それぞれの度数）が示される

```{r}
table4a %>%
  mutate(sum = `1999` + `2000`) %>%
  kbl() %>%
  kable_styling(
    bootstrap_options = c("striped"),
                full_width = T)
```

- カイ（ *χ* ）二乗検定（chi-square test）

  - 観測された度数と期待値に偏りがあるかを検定する
  
  - *χ* 二乗値は *χ* 二乗分布に近似的に従うという理論に基づいている
  
- カイ二乗検定の前提と留意点

  - 観測データの独立性
  
    - データを表に分類する際に、そのデータはいずれか1つのセルに1回しか入れられない
  
  - 正規分布は仮定しないが、標本が無作為抽出されていることが前提
  
  - サンプルサイズ
  
    - 最低1つのセルの期待値が5以上
    
      - 5以下の場合はフィッシャーの正確確率検定が使用される
    
  - 対応のあるデータの分析はできない
  
  - 2 × 2の表（自由度 1）の場合、Type 1 Errorが大きくなる
    
    - この場合フィッシャーの正確確率検定か、イェーツの補正をかけた *p* 値を報告する。しかし、イェーツの補正は過剰に修正されるため、フィッシャーの正確確率検定の方が推奨されている
  
- 1変数のカイ二乗検定は**適合度検定**、2変数のカイ二乗検定は**独立性の検定**とも呼ばれる

### カイ二乗検定（1変数）

### データの読み込み

- 英語の授業で60名の学生に対し、歌、映画、ニュースのどれを使った授業を受講したいかのアンケートを実施。これら3つの種類の希望者の数に有意な違いがあるかを調べる。

  - 3つのカテゴリの期待値は、それぞれ $\frac{60}{3} = 20$
  
  - 帰無仮説：「3つの種類の度数は一様である」

```{r}
dat <- read.csv("../stat_class_2025/sample_data/chisq.csv")
```

### 中身の確認

```{r}
head(dat, 3)
```

### クロス集計表

```{r}
table(dat)
```

### カイ二乗検定の実施

- ```table()```の結果を保存

```{r}
tx <- table(dat)
```

- ```chisq.test()```関数を実行

- *p* 値が有意水準 .05以下になっており、受講希望に有意差がある
```{r}
library(stats)
chisq.test(tx)
```

### 多重比較
- 3つの種類のどこに有意差があるかを検定する

  - 各カテゴリ間でカイ二乗検定を3回行う。検定を繰り返すため、ボンフェロー二の方法で有意水準の調節をする

  - 3回繰り返すため、有意水準の .05を3で割った値を基準にする（ *p* = .167）

- 映画 vs. ニュース  
```{r}
chisq.test(c(29, 14), p = c(0.5, 0.5))
```

- 映画 vs. 歌 
```{r}
chisq.test(c(29, 17), p = c(0.5, 0.5))
```

- 歌 vs. ニュース  
```{r}
chisq.test(c(17, 14), p = c(0.5, 0.5))
```

### 論文への記載
学生60名に映画、ニュース、歌のうちどれを使った授業を受講したいか調査した結果、それぞれ29、17、14人であった。カイ二乗検定を行った結果、*χ^2*(2) = 6.30、*p* = .0429と5%有意水準で受講希望者が有意に異なっていた。そこで多重比較を行い、ボンフェロー二の方法で補正した有意水準（ *α* = .0167）と比較した結果、どこにも有意差は見られなかった。

  - *χ^2*(自由度)

### 3×3分割表のカイ二乗検定
高校生55名の単語テストの得点順に3グループに分けた後、「声に出す」「書き写す」あるいは、その「両方」のいずれの方法で暗記したかを尋ねた。

  - 帰無仮説：「単語テストの成績と暗記方法に関連はない」

```{r, echo=FALSE}
data <- matrix(c(
  4, 7, 10,
  6, 4, 6,
  13, 3, 2), nrow = 3, byrow = TRUE)

colnames(data) <- c("両方", "書き写す", "声に出す")
rownames(data) <- c("下位群(1)", "下位群(2)", "下位群(3)")

table_data <- as.table(data)
print(table_data)
```


### 練習用データの作成
```{r}
x <- matrix(c(4, 7, 10, 6, 4, 6, 13, 3, 2),
            ncol = 3, nrow = 3, byrow = T)
```

### カイ二乗検定の実施

- 期待度数が0、もしくは期待度数が5未満になるセルが全体の20%以上の場合に警告メッセージが表示される。

- この場合、Fisherの正確確率検定の値を確認する

```{r}
res <- chisq.test(x)
res
```

```{r}
stats::fisher.test(x)
```

### 効果量の算出
- ```vcd```パッケージの```assocstats```関数でCramerの *V* を算出する

```{r}
#install.packages("vcd")
```

```{r}
library(vcd)
assocstats(x)
```

### 調整済み標準化残差の確認

- 絶対値1.96（5%水準棄却値）より絶対値が大きいものを確認

```{r}
res$stdres
```

### 結果の記載
単語テストを受けた55名の単語の暗記方法とテストの成績に関連があるかをカイ2乗検定で分析した。その結果、*χ^* (1) = 11.82、*p* = .018、 Cramer' *V* = .33と、有意な関連が見られた。 クロス集計表で期待値5未満が全体の20%以上あったため、Fisherの直接法を行った。その結果、*p* = .017と5%水準で有意だった。そこで、標準残差で判断したところ、上位群は暗記の際に声を出す方法だけを使用する場合が有意に少なく（ *z* = -2.38, *p* < .05）、その方法と書き写す方法の両方を使う傾向にあることがわかった（*z* = -3.19, *p* < .08）。それに対して、下位群は声を出す方法だけを使う傾向があり（ *z* = 1.85. *p* <.05）、両方の方法を使うことが有意に少なかった（ *z* = -2.69, *p* < .01）。中位群にはそのような顕著な傾向はみられなかった。

## リスク比とオッズ比
- 2群のカテゴリデータの効果量として使われる

### リスク比（相対危険度）
- 「海外経験がある人は英語を話すのが好きな傾向があるか」

```{r, echo=FALSE}
data <- matrix(c(10, 11, 21, 8, 25, 33, 18, 36, 54), 
               nrow = 3, byrow = TRUE)
rownames(data) <- c("海外経験あり", "海外経験なし", "計")
colnames(data) <- c("好き", "嫌い", "計")

data %>%
  kbl() %>%
  kable_styling(
    bootstrap_options = c("striped"),
                full_width = T)
```


- 海外経験のある人で英語で話すのが好きな人の割合

\[
リスク = \frac{10}{10 + 11} = \frac{\text{海外経験あり群で英語を話すのが好き}}{\text{海外経験あり群全体}} = \frac{10}{21} = 0.476
\]

- 海外経験のない人で英語で話すのが好きな人の割合

\[
リスク = \frac{8}{8 + 25} = \frac{\text{海外経験なし群で英語を話すのが好き}}{\text{海外経験なし群全体}} = \frac{10}{21} = 0.476
\]

-  リスク比の算出

  - 海外経験のある人で英語を話すのが好きな人は、海外経験のない人の何倍か
  
\[
リスク比 = \frac{0.4762}{0.2424} = \frac{\text{海外経験のある人で英語で話すのが好きな人の割合}}{\text{海外経験のない人で英語で話すのが好きな人の割合}} = 1.964
\]

  - 海外経験のある人で英語を話すのが好きになる確率は、海外経験のない人の約2倍である

### オッズ比

- 海外経験のある人

\[
オッズ = \frac{\text{海外経験あり群で英語を話すのが好き}}{\text{海外経験あり群で英語を話すのが嫌い}} = \frac{10}{11} = 0.909
\]

  - 海外経験のある人は英語を話すのが好きと嫌いの比率がほぼ等しい
  

- 海外経験のない

\[
オッズ = \frac{\text{海外経験なし群で英語を話すのが好き}}{\text{海外経験なし群で英語を話すのが嫌い}} = \frac{8}{25} = 0.320
\]

  - 海外経験のない人は英語を話すのが好きと嫌いの比率は0.320:1で、嫌いが約3倍高い
  
- オッズ比の計算
\[
オッズ比 =  \frac{0.909}{0.320} = 2.841
\]

  - 海外経験のある人は、英語を話すのが好きになる確率が、海外経験のない人の2.84倍である

::: infobox
リスク比もオッズ比も、分子を何にするかで数値やその解釈が変わる。分子に大きい値の方を持ってくる方が解釈しやすい。結果が分かった後に、その原因をさかのぼって調査する研究（後ろ向き調査）では、リスク比を使うことができない。
:::
  
## 対応のあるデータを比較する

### マクネマー検定
- 2 × 2分割表で使用される

- *t* 検定に似ている

- 話すことへの自信に関するアンケート調査

  - 話す前と後で自信に統計的有意な変化があったかを分析する
  
```{r, echo=FALSE}
data <- matrix(c(15, 21, 3, 11), 
               nrow = 2, byrow = TRUE)
rownames(data) <- c("ない", "ある")
colnames(data) <- c("ない", "ある")

data %>%
  kbl() %>%
  kable_styling(
    bootstrap_options = c("striped"),
    full_width = TRUE
  ) %>%
  add_header_above(c("留学前" = 1, "留学後" = 2)) %>%
  column_spec(1, bold = TRUE, color = "black") 
```

-  データの読み込み

  - 1列目と2列目のデータのみ読み込む

```{r}
dat <- read.csv("../stat_class_2025/sample_data/McN_Signed.csv")[1:2]
```

```{r}
head(dat)
```

- ```table()```で分割表を作成する

```{r}
table(dat$Before2, dat$After2)
```

- ```mcnemar.test()```で分析を行う

```{r}
stats::mcnemar.test(dat$Before2, dat$After2)
```

- 効果量の算出

\[
効果量 r = \sqrt\frac{{χ^2}}{N} = \sqrt\frac{12.04}{21 + 3} = 0.708
\]

-  結果の記載
1年問の留学を経験した50名の学生に対して、留学先の言語で話す自信があるかを留学前後で尋ね、その変
化をマクネマー検定で分析した。その結果、留学前後で、「自信がない」から「自信がある」となった学生は21
名で、逆に、「自信がある」から「自信がない」に変わった学生は3名で、検定の結果、*p* < .001で有意な変化が見られた。また、効果量も *r* = .71と大きく、1年問の留学は、話すことへの自信につながることが示された。

### コクランのQ検定
- 対応ある3変数以上の間でそれぞれの比率に変化や差があるかを検定（フリードマン検定の2値データ版）。

  - データは2値データ
  
  - 帰無仮説「1/0の比率がすべての変数間で等しい」

  - 最低でも10以上のサンプルが必要
  
- データの読み込み

```{r}
dat <- read.csv("../stat_class_2025/sample_data/Cochran.csv")
```

```{r}
head(dat, 2)
```

- ```nonpar```パッケージの```cochrans.q()```関数を使う

```{r}
#install.packages("nonpar")
library(nonpar)
cochrans.q(dat)
```

- マクネマ―検定による多重比較

  - 4回行うので、*α* は 0.0125
  
```{r}
mcnemar.test(dat$Listening, dat$Speaking)
mcnemar.test(dat$Listening, dat$Writing)
mcnemar.test(dat$Reading, dat$Speaking)
mcnemar.test(dat$Reading, dat$Writing)
```

- 効果量はマクネマー同様に、カイ二乗値をデータ数で割ってルートを取る

- 記載例
学生15人に対して、英語の4技能に対する苦手意識を調査した技能問によって得意と感じる比率に差があるかどうかを、コクランの Q検定で検証したところ、*Q*(3) = 9.714, *p* = .021と 5%水準で有意であったそこで,マクネマー検定であらかじめ関心のある技能問で4回の多重比較を行ったところ、ボンフェロー二の方法で調整した有意水準( = .05/4 = 0.0125)で判断すると、どの条件間にも有意差はなかった。

## 順序尺度データ

### 順序尺度データを扱うノンパラメトリック検定の特徴

- 母集団から無作為抽出したデータであることを前提

- 正規性を仮定しないが、等分散性は仮定する

- 代表値として中央値、バラツキ度に（四分位）範囲、四分位偏差

  - 平均値は外れ値の影響を大きく受けてしまうため
  
  - Week 2のまとめセクションを参照

::: infobox
パラメトリック検定に比べ、外れ値が含まれるデータに頑健。しかし、サンプルサイズが極端に少ない場合や2群の散らばりが大きく偏っている場合は、正確な検定が困難になる

- サンプルサイズや散布度に問題がある場合

  - 正確確率検定：サンプルサイズがかなり小さい場合や偏りがある場合に推奨される（e.g., カイ二乗検定でのフィッシャーの正確確率検定）。サンプルサイズが大きい場合は、モンテカルロ法と呼ばれる、シミュレーションをもとにした解析法が用いられる。
:::

### 順序尺度検定の実施

### 対応なしの2群比較（ウィルコクソンの順位和検定）

- データ: 習得させたい単語を10名には句の形で、別の 10名には文の中で覚えさせ、2週間後にどちらの条件が単語の定着がより良かったかを調べたもの。

  - 帰無仮説：「単語提示条件の違いによって、語彙テスト得点の中央値に差はない」

```{r}
dat <- read.csv("../stat_class_2025/sample_data/WilcoxonRankSum.csv")
```

```{r}
head(dat, 3)
```

- 因子型データに変更
```{r}
dat$Condition <- factor(dat$Condition)
```

- 描画
```{r}
hist(dat$Vocabulary[dat$Condition == 1], main = "Phrase")
hist(dat$Vocabulary[dat$Condition == 2], main = "Sentence")
```

- 描画（並列）
```{r}
par(mfrow = c(1,2))
hist(dat$Vocabulary[dat$Condition == 1], main = "Phrase")
hist(dat$Vocabulary[dat$Condition == 2], main = "Sentence")
```

- 箱ひげ図 + 蜂群図

```{r}
with(dat, boxplot(Vocabulary ~ Condition, names = c("Phrase", "Sentence")))
library(beeswarm)
beeswarm(dat$Vocabulary ~ dat$Condition, add = T)
```

```{r}
library(psych)
describeBy(dat$Vocabulary, group = dat$Condition)
```

- 正規性がなく、データに同じ数字があるため、正確確率検定を行う

  ```paired = TRUE```にすると、符号付順位検定となる

```{r}
#install.packages("exactRankTests")
library(exactRankTests)

res <- wilcox.exact(dat$Vocabulary ~ dat$Condition,
                    paired = FALSE, correct = FALSE)

res
```

- 効果量の算出

```{r}
pval <- res$p.value

z1 <- qnorm(1-(pval/2))

r1 <- z1 / sqrt(length(dat$Vocabulary))

r1
```

- 結果の報告
それぞれ10名の生徒に句または文単位で単語を覚えさせた後、30点満点の語彙テストを行った。得点が正規分布から逸脱していたため、ウィルコクソンの順位和検定を用いて、暗記条件間で語彙の定着度に差があるかを検証した。その結果、文グループ（mediam = 22.5）が5%水準で有意に句グループ（mediam = 6.5）より高いことがわかった（ *W* = 22.5, *p* = .037, *r* = .47)。また、効果量も中程度以上であった。このことから、単語を文単
位で提示された方が、句単位で提示するより効果的だと言える。

### 1要因の対応ある2群の比較（ウィルコクソンの符号付順位検定）
- マクネマ―検定で使用したデータセットを使用する

  - 3列目と4列目のデータのみ読み込む

  - 学生50名に対し、6か月間の留学前後に、留学先の言語で話す自信度（ある[2]・少しある[1]・ない[0]）を尋ねた。順序性があるため順序尺度として扱い、留学前後でどう自信度が変化したかを分析する。

```{r}
dat <- read.csv("../stat_class_2025/sample_data/McN_Signed.csv")[3:4]
```

```{r}
head(dat)
```

```{r}
library(psych)
describe(dat)
```

```{r}
res <- wilcox.exact(dat$Before3, dat$After3, paired = T, correct = FALSE)

res
```

- 効果量の算出

  - 対応のあるデータのため、それぞれの条件のサンプルサイズを足す

```{r}
pval <- res$p.value
z1 <- qnorm(1-(pval/2))

r1 <- z1 / sqrt(100)

r1
```

- 結果の報告
50名の学生を対象に6ケ月の留学前後で,留学先の園語を話す自信にっいて変化があったかどうかを調査した。ウィルコクソンの符号付順位和検定の正確性検定で分析したところ、*V* = 22.5、*p* = .057、*p* = 0.190で有意差はなかった。

### 関係の強さ（順序相関係数）

  - スピアマンの順位相関係数、ケンドールの順位相関係数：ノンパラメトリック検定版の相関係数
  
  - 係数の解釈はパラメトリック検定と同じで、-1から1の間をとる

- 関数はピアソンの時と同じ ```cor.test()```。```method = ```個所で指定する。

```{markdown}
cor.test(変数A, 変数B, method = "spearman")
```

```{markdown}
cor.test(変数A, 変数B, method = "kendall")
```


- ここで紹介した以外にも、対応のない3群以上の比較で使用されるクラスカル・ウォリスの順位和検定や対応のある3条件以上の比較で使用されるフリードマン検定などがある

::: infobox
　ノンパラメトリック検定では、**中央値検定**、**順位検定**、**符号検定**などの種類がある。中央値検定では、中央値を超える人数と中央値以下の人数を数え、その比率を検討する。つまり、データの順番を無視し、2分割で検定を行う。順位和検定では、データのもつ順位が検定に考慮されるため、中央値検定よりもデータの持つ情報量の損失は小さい。
　符号検定では、対応のあるデータの中央値検定のような方法で、データの値が正か負かを考慮して検定しているため、こちらもデータの順位の情報は損失している。符号検定よりも順位付けを行う符号付順位検定の方がデータの情報の損失は小さい。
:::

## 次週までの課題
### 課題内容

1. 小テストに向けて今回の内容を復習する。必ず手でコードを入力してRを実行する。

2. （宿題を考える）
- ハンズオンセッションで使用したデータを基にサムコントラストで分析をしてみましょう

- **Rで数値を出力するだけでなく、それぞれの質問への回答を高校生にもわかりやすく文字で記載してください。**

### 提出方法
- メールにファイルを添付して送信。
- 締め切りは今週の木曜日まで

## 参考文献
- 平井et al. Rによる教育データ
- 三浦（監）「英語教師のための教育データ入門」
- 水本外国語教育ハンドブック
```{=html}
<style>
.infobox {
  padding: 1em 1em 1em 4em;
  margin-bottom: 10px;
  border: 2px solid orange;
  border-radius: 10px;
  background: #f5f5f5 5px center/3em no-repeat;
}

.beg {
  background-image: url("https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjHtu3kBX8P39WYBBAjar9c8c1ladK2SYL6_gEMXFweQfauWVhSvCQP5KELsPX5KNL1uOddLLQ-aeMxv904OW_NFFfANhBYObfBV09KO2EXehrb9kMdCLZY1afsChib-7zIkBJbG6OrbJpM/s400/aisatsu_kodomo_boy.png");}

.caution {
  background-image: url("https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhzMqkpQ7vLUKvumbm6AFwTLQiCe7tlDb2Q0MAiISLsesZHnhj0kbRjB4U3se3UrDIHfIy0hlahyphenhyphenQu-V2tOR2LcV_lX7U8P5a8jtqPYv3Ah4L-JoYi8PhoaoehumGIdp2vrsX0rRyhXqwA/s800/mark_chuui.png");}
  
</style>
```